<!DOCTYPE html>
<html>
<head>
    <script src="lists.js"></script>
    <script src="test.js"></script>
    <script src="util.js"></script>
</head>
<body>
<canvas id="canvas1" height="500" width="500"></canvas>
<script language="JavaScript">
function start(){
  var c = document.getElementById("canvas1");
  var ctx = c.getContext("2d");
  ctx.fillStyle = "#F0F0F0";
  ctx.strokeStyle = "#FF0000";

  //map(function(i){draw(c, ctx, i); }, seq(1, 4));

  ctx.strokeRect(0, 0, c.width, c.height);

  //ctx.beginPath(),
  //ctx.moveTo((c.width / 2), y1),
  //ctx.lineTo((c.width / 2), y2),
  //ctx.stroke();

  //console.log("Drawing");
  //console.log("Canvas width: " + c.width);

  lengths = map(length_fun(c), seq(1,5));

  perpendicular_line = {x1: c.width / 2,
                        y1: c.height,
                        x2: c.width / 2,
                        y2: c.height - hd(lengths),
                        a: Math.PI};

  var lines_ = lines(tl(lengths), Math.PI * .9, [perpendicular_line], []);
  map(function(line){ draw_line(ctx, line) }, lines_);
}

function length_fun(canvas){
  return function(i){
             return length(canvas, i);
         };
}

function length(canvas, i){
  return canvas.height / (i * 3);
}

// for every point, angle and count, create N more points at angles N0..N1 where N is > 1

function lines(lengths, arc, parent_lines, ancestor_lines){
  //console.log("lengths: " + lengths);
  //console.log("arc: " + arc);
  //console.log("parent_lines: " + parent_lines);
  //console.log("ancestor_lines: " + ancestor_lines);
  if(lengths.length == 0){
    return ancestor_lines;
  }
  var angles = arc_angles(4, arc);
  //console.log("angles: " + angles);
  var restLengths = tl(lengths);
  var restLines = concat(parent_lines, ancestor_lines);
  var line_angles = cross_product(parent_lines, angles);
  var newLines = map(line_fun(hd(lengths)), line_angles);
  return lines(restLengths, arc, newLines, restLines);
}

function num_lines(){
    return 3;
}

function arc_angles(num, arc){
  var leftOver = Math.PI * 2 - arc;
  var padding = leftOver / 2;
  //console.log("Creating " + num + " angles in arc " + arc + " with padding " + padding);
  return map(function(i){ return (i * arc/(num - 1)) + padding}, seq(0, num - 1));
}

function line_fun(length){
  return function(line_angle){
           var parent_line = line_angle.one;
           var angle = line_angle.two;
           return line(parent_line, length, angle);
         };
}

/* The theory here is that depending on which direction
 * we're going we'll either need to add or subtract the
 * x and y deltas. The x and y deltas are calculated base
 * on the specified angle and the length of line specified.
 * i.e. start at X,Y and go length L at angle A.
 */
function line(parent_line, length, angle){
  //console.log("line with angle: " + angle);
  var x1 = parent_line.x2;
  var y1 = parent_line.y2;
  var parent_angle = parent_line.a;
  //var total_angle = parent_angle + angle;
  var total_angle = parent_angle + angle - (Math.PI);
  //var total_angle = angle;
  var normalized_angle = normalize_angle(total_angle);
  var xd_translate = x_translation(total_angle);
  var yd_translate = y_translation(total_angle);
  var sin = Math.sin(normalized_angle);
  var cos = Math.cos(normalized_angle);
  //console.log("parent angle: " + parent_angle + "; " +
  //            "angle: " + angle + "; " +
  //            "total_angle: " + total_angle + "; " +
  //            "normalized_angle: " + normalized_angle + "; " +
  //            "xd_translate: " + xd_translate + "; " +
  //            "yd_translate: " + yd_translate + "; " +
  //            "sin: " + sin + "; " +
  //            "cos: " + cos + "; ");
  var xd = Math.sin(normalized_angle) * length * xd_translate;
  var yd = Math.cos(normalized_angle) * length * yd_translate;
  //console.log("xd: " + xd + "; yd: " + yd);
  var x2 = x1 + xd;
  var y2 = y1 + yd;
  //console.log("Line: x1: " + x1 + "; x2: " + x2 + "; y1: " + y1 + "; y2: " + y2 + "; " +
  //            "a: " + angle);
  return {x1: x1, y1: y1, x2: x2, y2: y2, a: angle};
}

function normalize_angle(angle){
  var clamped = angle % (Math.PI / 2);
  if(angle >= 0 && angle < Math.PI / 2){
    return clamped;
  }else if(angle >= Math.PI / 2 && angle < Math.PI){
    return Math.PI / 2 - clamped;
  }else if(angle >= Math.PI && angle < Math.PI * 1.5){
    return clamped;
  }else{
    return Math.PI / 2 - clamped;
  }
}

function x_translation(angle){
  //if(angle >= (3 / 2 * Math.PI) || angle <= Math.PI / 2){
  if(angle >= 0 && angle <= Math.PI){
    return -1;
  }else{
    return 1;
  }
}

function y_translation(angle){
  //if(angle >= 0 && (angle <= Math.PI)){
  if(angle >= (3 / 2 * Math.PI) || angle <= Math.PI / 2){
    return 1;
  }else{
    return -1;
  }
}

function cross_product(xs, ys){
  return flatten(map(function(x){
                         return map(function(y){
                                        return {one: x, two: y}
                                    }, ys)
                     }, xs))
}

function flatten(xs, maybe_result){
  var results = (maybe_result == undefined ? [] : maybe_result.slice(0));
  if(xs.length == 0){
    return results;
  }
  var next = hd(xs);
  var rest = tl(xs);
  if(Array.isArray(next)){
    return concat(concat(flatten(next), results), flatten(rest));
  }
  return concat(cons(results, next), flatten(rest));
}

function set(obj, field, value){
  copy = clone(obj);
  copy[field] = value;
  return copy;
}

function draw_line(ctx, line){
  ctx.beginPath(),
  ctx.moveTo(line.x1, line.y1),
  ctx.lineTo(line.x2, line.y2),
  ctx.stroke();
}

start();
</script>
</body>
</html>
